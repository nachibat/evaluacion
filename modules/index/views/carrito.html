{% extends './inicio.html' %}
{% block styles %} 
    <style type="text/css">
        .btn:disabled{
            cursor: no-drop;
        }
        .ops{
            text-align: center;
            padding: 0.1rem .75rem !important;
            vertical-align: middle !important;
        }
        .ops [disabled]{
            opacity: 0.2;
        }
        .checks {
            text-align: start;
        }
        .imagen {
            width: 40px;
            height: 40px;
            background-image: url('/assets/img/no_image.jpg');
            background-repeat: no-repeat;
            background-size: cover;
        }
        table td {
            vertical-align: inherit !important;
        }
    </style>
{% endblock %}

{% block content %}
<div id="tabla-principal" class="row">
    <div class="col-md-12 d-flex">
        <h4 id="title"><i class="fa fa-shopping-cart"></i>&nbsp;Carrito</h4>
    </div>
    <div class="col-12 mt-4" style="overflow-x: auto;">
        <table class="table table-striped tableFixHead" id="carrito">
            <thead>
                <th style="width: 50px;"></th>
                <th style="min-width: 130px;">Descripción artículo</th>
                <th>Precio unitario</th>
                <th>Rubro</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th style="text-align: center; width: 190px; min-width: 190px;">Acciones</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="col-12 d-flex justify-content-end align-items-center">
        <span><h6 class="mb-0 mr-2">Método de pago </h6></span>
        <div style="width: 225px;">
            <select id="medios-pago" class="form-control mt-1"></select>
        </div>
    </div>
    <div class="col-12 text-right mt-2">
        <h6 class="d-inline">Total a pagar: $ </h6>
        <span id="total"></span>
    </div>
    <div class="col-12 text-right mt-2">
        <button id="compra" onclick="checkout()" class="btn btn-round btn-primary">Realizar pedido</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let carrito = [];
    let userId;
    let total = 0;
    !(async function($) {
        "use strict";
        let cards = $('#cards');
        cards.remove();
        const session = await $.get('/session');
        userId = session.user.id;
        if (session.user.carrito?.length) {
            for (let item of session.user.carrito) {
                const res = await $.get(`/articulo/${item.idArt ? item.idArt : item.id}`);
                let articulo = res.articulo[0];
                articulo.cantidad = item.cantidad;
                carrito.push(articulo);
            }
        }
        renderData(carrito);
        await cargarMediosDePago();
        
    })(jQuery);

    function renderData(carrito) {
        if (carrito.length) {
            let data = $('#carrito tbody');
            data.empty();
            carrito.forEach(item => {
                const precioUnitario = item.precio + item.precio * item.iva / 100;
                const subtotal = precioUnitario * item.cantidad;
                total += subtotal;
                let row = `
                    <tr>
                        <td>
                            <div class="imagen">
                                <div style="width: 100%; height: 100%; background-image: url(${item.img}); background-repeat: no-repeat; background-size: cover;"></div>
                            </div>
                        </td>
                        <td>${item.descripcion}</td>
                        <td>${precioUnitario}</td>
                        <td>${item.rubro}</td>
                        <td>${item.cantidad}</td>
                        <td>${subtotal}</td>
                        <td class="ops">
                            <a onclick="cambiarCantidad(${item.id}, ${item.cantidad})" class="btn btn-round btn-sm btn-warning" title="Cambiar cantidad" data-toggle="tooltip"><i class="fa fa-pen"></i></a>
                            <button class="btn btn-round btn-sm btn-danger" data-toggle="tooltip" onclick="eliminarItem(${item.id})"
                                data-id="{{ item.id }}" title="Quitar del carrito"><i class="fa fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                data.append(row);
            });
            $('#total').empty();
            $('#total').append(total);
        } else {
            $('#tabla-principal').empty();
            $('#tabla-principal').append(`
                <div class="col-12 mt-4">
                    <h5>No hay items seleccionados</h5>    
                </div>
            `);
        }
    }
    async function cargarMediosDePago() {
        const mediosDePago = await $.get('/medios-pago');
        mediosDePago.forEach(item => {
            $('#medios-pago').append(`
                <option value="${item.id}">${item.descripcion}</option>
            `);
        });
    }
    async function eliminarItem(idItem) {
        Swal.fire({
            title: 'Confirmar',
            text: "Desea quitar este artículo del carrito?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar',
        }).then(async result => {
            if (result.value) {
                const idx = carrito.findIndex(item => item.id === idItem);
                if (idx > -1) carrito.splice(idx, 1);
                renderData(carrito);
                await $.post('/session/carrito', { carrito });
            }
        });
    }

    async function cambiarCantidad(idItem, cant) {
        Swal.fire({
            title: 'Cambiar cantidad',
            html: `
                <br>
                <div class="form-group d-flex justify-content-center">
                    <input class="form-control" style="width: 100px" maxlength="2" type="number" value="${cant}" id="cantidad" placeholder="Cantidad" autocomplete="off" min="1">
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                if ($('#cantidad').val().trim() === '') {
                    Swal.showValidationMessage(`La cantidad no puede estar vacia`)
                    return false;;
                }
                if (parseInt($('#cantidad').val().trim()) < 1) {
                    Swal.showValidationMessage('La cantidad debe ser mayor o igual a 1');
                    return false;
                }
            }
        }).then(async result => {
            if (result.value) {
                const idx = carrito.findIndex(item => item.id === idItem);
                if (idx > -1) carrito[idx].cantidad = Math.abs($('#cantidad').val());
                renderData(carrito);
                await $.post('/session/carrito', { carrito });
            }
        });
    }
    async function checkout() {
        const data = {
            userId,
            carrito,
            medioPago: $('#medios-pago').val(),
            total
        };
        console.log(data);
    }
</script>
{% endblock %}