{% extends './inicio.html' %}
{% block styles %} 
    <style type="text/css">
        .btn:disabled{
            cursor: no-drop;
        }
        .ops{
            text-align: center;
            padding: 0.1rem .75rem !important;
            vertical-align: middle !important;
        }
        .ops [disabled]{
            opacity: 0.2;
        }
        .checks {
            text-align: start;
        }
        .imagen {
            width: 40px;
            height: 40px;
            background-image: url('/assets/img/no_image.jpg');
            background-repeat: no-repeat;
            background-size: cover;
        }
        table td {
            vertical-align: inherit !important;
        }
    </style>
{% endblock %}

{% block content %}
<div id="tabla-principal" class="row">
    <div class="col-md-12 d-flex">
        <h4 id="title"><i class="fa fa-shopping-cart"></i>&nbsp;Carrito</h4>
    </div>
    <div class="col-12 mt-4" style="overflow-x: auto;">
        <table class="table table-striped tableFixHead" id="carrito">
            <thead>
                <th style="width: 50px;"></th>
                <th style="min-width: 130px;">Descripción artículo</th>
                <th>Precio unitario</th>
                <th>Rubro</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th style="text-align: center; width: 190px; min-width: 190px;">Acciones</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="col-12 text-right">
        <h5 class="d-inline">Total a pagar: $ </h5>
        <span id="total"></span>
    </div>
    <div class="col-12 d-flex justify-content-end">
        <div style="width: 225px;">
            <select id="medios-pago" class="form-control mt-1"></select>
        </div>
    </div>
    <div class="col-12 text-right mt-2">
        <button id="compra" class="btn btn-round btn-primary">Realizar pedido</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    !(async function($) {
        "use strict";
        let cards = $('#cards');
        cards.remove();
        const session = await $.get('/session');
        let carrito = [];
        if (session.user.carrito?.length) {
            for (let item of session.user.carrito) {
                const res = await $.get(`/articulo/${item.idArt}`);
                let articulo = res.articulo[0];
                articulo.cantidad = item.cantidad;
                carrito.push(articulo);
            }
        }
        if (carrito.length) {
            renderData(carrito);
            await cargarMediosDePago();
        } else {
            $('#tabla-principal').empty();
            $('#tabla-principal').append(`
                <div class="col-12 mt-4">
                    <h5>No hay items seleccionados</h5>    
                </div>
            `);
        }
    })(jQuery);

    function renderData(carrito) {
        let data = $('#carrito tbody');
        let total = 0;
        carrito.forEach(item => {
            const precioUnitario = item.precio + item.precio * item.iva / 100;
            const subtotal = precioUnitario * item.cantidad;
            total += subtotal;
            let row = `
                <tr>
                    <td>
                        <div class="imagen">
                            <div style="width: 100%; height: 100%; background-image: url(${item.img}); background-repeat: no-repeat; background-size: cover;"></div>
                        </div>
                    </td>
                    <td>${item.descripcion}</td>
                    <td>${precioUnitario}</td>
                    <td>${item.rubro}</td>
                    <td>${item.cantidad}</td>
                    <td>${subtotal}</td>
                    <td class="ops">
                        <a href="#" class="btn btn-round btn-sm btn-warning" title="Aumentar" data-toggle="tooltip"><i class="fa fa-pen"></i></a>
                        <button class="btn btn-round btn-sm btn-danger" data-toggle="tooltip" onclick="BorrarArticulo('{{ item.id }}')"
                            data-id="{{ item.id }}" title="Quitar del carrito"><i class="fa fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
            data.append(row);
        });
        $('#total').append(total);
    }
    async function cargarMediosDePago() {
        const mediosDePago = await $.get('/medios-pago');
        mediosDePago.forEach(item => {
            $('#medios-pago').append(`
                <option value="${item.id}">${item.descripcion}</option>
            `);
        });
    }
</script>
{% endblock %}